import{createServer as S}from"http";import b from"morgan";import R from"express";import P from"cors";import{Server as v}from"socket.io";import"dotenv/config";import N from"puppeteer";import"axios";import"proxy-chain";var h=async({phones:i,io:t,i:s,indexingPhones:n})=>{let c=async()=>{let a=await N.launch({headless:!1}),r=await a.newPage();r.setDefaultNavigationTimeout(0),r.setDefaultTimeout(0),await r.goto("https://portalpagos.claro.com.co/phrame.php?action=despliegue_personal&clase=vistasclaro&metodo=pantalla_inicio&empresa=claro#no-back-button"),t.to(s).emit("[claro] exectMsg",`Instancia ${s} ejecutandose....`),await r.waitForSelector("h1");let p=await r.$("h1"),l=await r.evaluate(w=>w?.innerText,p);return console.log(l!="Portal de PAGOS Y RECARGAS"),l!="Portal de PAGOS Y RECARGAS"?(console.log("entro"),await a.close(),{page:!1,browser:!1}):{page:r,browser:a}},o=!1,u=!1;do{let a=await c();o=a.page,u=a.browser}while(o==!1);for(let a of i)try{await o.waitForSelector("#select > div > h1");let r=new Date,{price:p,status:l}=await o.evaluate(async f=>{let I=new Headers,e=new FormData;e.append("FLUJOPAGOGW","PFPHM"),e.append("FLUJOPAGO","10002"),e.append("ex",""),e.append("paramLista",""),e.append("action","despliegue_personal"),e.append("campos_borrar","CLACO_NUMERO"),e.append("operacion","Adicionar"),e.append("url_modal",""),e.append("id_objeto","10002"),e.append("valor_llave",""),e.append("parametros_padre","&ValorTotal=&SaldoParcial=&NumeroCelular=&FechaVencimiento=&FORMA_PAGO=&VALOR_PLAN=&VALOR_CUOTEQUIP=&FECHA_CARGADATOS=&CODIGO_CLIENTE="),e.append("mensaje_error","Debe asignar a un responsable para la actividad a seguir"),e.append("go",""),e.append("preguardar",""),e.append("confGuardaComo","Seguro que desea duplicar este registro"),e.append("modifi_detalle",""),e.append("nombre_campo",""),e.append("latitud",""),e.append("longitud",""),e.append("enviarForm",""),e.append("autoguardar",""),e.append("guion_encuesta",""),e.append("clase","vistasclaro"),e.append("metodo","confirmacion"),e.append("empresa","claro"),e.append("NumeroCelular",`${f}`),e.append("CLACO_NUMERO",""),e.append("NRO_CUENTA",""),e.append("TIPO_TRANS",""),e.append("USRIO_NUMERO",""),e.append("IPTRANSACCION",""),e.append("TIPO_TRANS_ORIG",""),e.append("FECHA_INICIO","2024-07-13 02:21"),e.append("NumeroIdentificacion",""),e.append("CodigoCliente",""),e.append("IdentificacionDeudor",""),e.append("OrigenPago",""),e.append("mySubmit_","Continuar");let A=await fetch("https://portalpagos.claro.com.co/phrame.php?id_objeto=100002",{method:"POST",headers:I,body:e,redirect:"follow"}),O=(await A.text()).split(`
`).filter(d=>d.includes("ValorTotalEdit")).map(d=>d.split(/[<>]/g)).flat().filter(d=>d.includes("$"))[0]?.split(",")[0].replaceAll("$","").replaceAll(".","");return console.log(O),{price:O,status:A.status}},a);if(console.log(p,l),l==403&&await o.reload(),l==403)throw t.to(s).emit("[claro] exectMsg",`HA OCURRIDO UN ERROR CON LA INSTANCIA ${s} SE CERRARA AUTOMATICAMENTE`),"error 403 ";(await o.cookies("https://portalpagos.claro.com.co/index.php?view=vistas/personal/claro/newclaro/inicio.php&id_objeto=#no-back-button")).map(async({name:f})=>await o.deleteCookie({name:f}));let g=new Date().getTime()-r.getTime()+"ms";if(p){await t.to(s).emit("[claro] live",{price:p,time:g,index:n.indexOf(a),phone:a});continue}await t.to(s).emit("[claro] dead",{time:g,index:n.indexOf(a),phone:a})}catch{await u.close();do{let p=await c();o=p.page,u=p.browser}while(o==!1);continue}};var m=R();m.use(P({origin:"*"}));m.use(R.json({limit:"100mb"}));m.use(b("common"));var C=3e3,T=S(m),_=new v(T,{cors:"*",maxHttpBufferSize:1e10});m.get("*",async(i,t)=>{t.json({ok:!0})});_.on("connection",async i=>{try{let t=i.handshake?.query.instancias,s=[...Array(Number(t))].map((n,c)=>n=++c).map(async n=>await i.join(n));i.on("[claro] postpago",async({phones:n,i:c,indexingPhones:o})=>{h({phones:n,io:_,i:c,indexingPhones:o})})}catch(t){console.log(t)}});T.listen(C??0,()=>console.log(`conectado al servidor ${C}`));export{_ as io};
